


const rom = [
	// Offset 0x00000000 to 0x000002F8
	0x12, 0x0A, 0x60, 0x01, 0x00, 0xEE, 0x60, 0x02, 0x12, 0xA6, 0x00, 0xE0,
	0x68, 0x32, 0x6B, 0x1A, 0xA4, 0xF1, 0xD8, 0xB4, 0x68, 0x3A, 0xA4, 0xF5,
	0xD8, 0xB4, 0x68, 0x02, 0x69, 0x06, 0x6A, 0x0B, 0x6B, 0x01, 0x65, 0x2A,
	0x66, 0x2B, 0xA4, 0xB5, 0xD8, 0xB4, 0xA4, 0xED, 0xD9, 0xB4, 0xA4, 0xA5,
	0x36, 0x2B, 0xA4, 0xA1, 0xDA, 0xB4, 0x6B, 0x06, 0xA4, 0xB9, 0xD8, 0xB4,
	0xA4, 0xED, 0xD9, 0xB4, 0xA4, 0xA1, 0x45, 0x2A, 0xA4, 0xA5, 0xDA, 0xB4,
	0x6B, 0x0B, 0xA4, 0xBD, 0xD8, 0xB4, 0xA4, 0xED, 0xD9, 0xB4, 0xA4, 0xA1,
	0x55, 0x60, 0xA4, 0xA5, 0xDA, 0xB4, 0x6B, 0x10, 0xA4, 0xC5, 0xD8, 0xB4,
	0xA4, 0xED, 0xD9, 0xB4, 0xA4, 0xA1, 0x76, 0xFF, 0x46, 0x2A, 0xA4, 0xA5,
	0xDA, 0xB4, 0x7B, 0x05, 0xA4, 0xCD, 0xD8, 0xB4, 0xA4, 0xED, 0xD9, 0xB4,
	0xA4, 0xA1, 0x95, 0x60, 0xA4, 0xA5, 0xDA, 0xB4, 0x7B, 0x05, 0xA4, 0xAD,
	0xD8, 0xB4, 0xA4, 0xED, 0xD9, 0xB4, 0xA4, 0xA5, 0x12, 0x90, 0xA4, 0xA1,
	0xDA, 0xB4, 0x68, 0x12, 0x69, 0x16, 0x6A, 0x1B, 0x6B, 0x01, 0xA4, 0xB1,
	0xD8, 0xB4, 0xA4, 0xED, 0xD9, 0xB4, 0x60, 0x00, 0x22, 0x02, 0xA4, 0xA5,
	0x40, 0x00, 0xA4, 0xA1, 0xDA, 0xB4, 0x7B, 0x05, 0xA4, 0xA9, 0xD8, 0xB4,
	0xA4, 0xE1, 0xD9, 0xB4, 0xA4, 0xA5, 0x40, 0x02, 0xA4, 0xA1, 0x30, 0x00,
	0xDA, 0xB4, 0x7B, 0x05, 0xA4, 0xC9, 0xD8, 0xB4, 0xA4, 0xA9, 0xD9, 0xB4,
	0xA4, 0xA1, 0x65, 0x2A, 0x67, 0x00, 0x87, 0x50, 0x47, 0x2A, 0xA4, 0xA5,
	0xDA, 0xB4, 0x7B, 0x05, 0xA4, 0xC9, 0xD8, 0xB4, 0xA4, 0xAD, 0xD9, 0xB4,
	0xA4, 0xA1, 0x66, 0x0B, 0x67, 0x2A, 0x87, 0x61, 0x47, 0x2B, 0xA4, 0xA5,
	0xDA, 0xB4, 0x7B, 0x05, 0xA4, 0xC9, 0xD8, 0xB4, 0xA4, 0xB1, 0xD9, 0xB4,
	0xA4, 0xA1, 0x66, 0x78, 0x67, 0x1F, 0x87, 0x62, 0x47, 0x18, 0xA4, 0xA5,
	0xDA, 0xB4, 0x7B, 0x05, 0xA4, 0xC9, 0xD8, 0xB4, 0xA4, 0xB5, 0xD9, 0xB4,
	0xA4, 0xA1, 0x66, 0x78, 0x67, 0x1F, 0x87, 0x63, 0x47, 0x67, 0xA4, 0xA5,
	0xDA, 0xB4, 0x68, 0x22, 0x69, 0x26, 0x6A, 0x2B, 0x6B, 0x01, 0xA4, 0xC9,
	0xD8, 0xB4, 0xA4, 0xB9, 0xD9, 0xB4, 0xA4, 0xA1, 0x66, 0x8C, 0x67, 0x8C,
	0x87, 0x64, 0x47, 0x18, 0xA4, 0xA5, 0xDA, 0xB4, 0x7B, 0x05, 0xA4, 0xC9,
	0xD8, 0xB4, 0xA4, 0xBD, 0xD9, 0xB4, 0xA4, 0xA1, 0x66, 0x8C, 0x67, 0x78,
	0x87, 0x65, 0x47, 0xEC, 0xA4, 0xA5, 0xDA, 0xB4, 0x7B, 0x05, 0xA4, 0xC9,
	0xD8, 0xB4, 0xA4, 0xC5, 0xD9, 0xB4, 0xA4, 0xA1, 0x66, 0x78, 0x67, 0x8C,
	0x87, 0x67, 0x47, 0xEC, 0xA4, 0xA5, 0xDA, 0xB4, 0x7B, 0x05, 0xA4, 0xC9,
	0xD8, 0xB4, 0xA4, 0xC1, 0xD9, 0xB4, 0xA4, 0xA1, 0x66, 0x0F, 0x86, 0x66,
	0x46, 0x07, 0xA4, 0xA5, 0xDA, 0xB4, 0x7B, 0x05, 0xA4, 0xC9, 0xD8, 0xB4,
	0xA4, 0xE1, 0xD9, 0xB4, 0xA4, 0xA1, 0x66, 0xE0, 0x86, 0x6E, 0x46, 0xC0,
	0xA4, 0xA5, 0xDA, 0xB4, 0x7B, 0x05, 0xA4, 0xE5, 0xD8, 0xB4, 0xA4, 0xC1,
	0xD9, 0xB4, 0xA4, 0x9E, 0xF1, 0x65, 0xA4, 0xA5, 0x30, 0xAA, 0xA4, 0xA1,
	0x31, 0x55, 0xA4, 0xA1, 0xDA, 0xB4, 0x68, 0x32, 0x69, 0x36, 0x6A, 0x3B,
	0x6B, 0x01, 0xA4, 0xE5, 0xD8, 0xB4, 0xA4, 0xBD, 0xD9, 0xB4, 0xA4, 0x9E,
	0x60, 0x00, 0x61, 0x30, 0xF1, 0x55, 0xA4, 0x9E, 0xF0, 0x65, 0x81, 0x00,
	0xA4, 0x9F, 0xF0, 0x65, 0xA4, 0xA5, 0x30, 0x30, 0xA4, 0xA1, 0x31, 0x00,
	0xA4, 0xA1, 0xDA, 0xB4, 0x7B, 0x05, 0xA4, 0xE5, 0xD8, 0xB4, 0xA4, 0xB5,
	0xD9, 0xB4, 0xA4, 0x9E, 0x66, 0x89, 0xF6, 0x33, 0xF2, 0x65, 0xA4, 0xA1,
	0x30, 0x01, 0x14, 0x32, 0x31, 0x03, 0x14, 0x32, 0x32, 0x07, 0x14, 0x32,
	0xA4, 0x9E, 0x66, 0x41, 0xF6, 0x33, 0xF2, 0x65, 0xA4, 0xA1, 0x30, 0x00,
	0x14, 0x32, 0x31, 0x06, 0x14, 0x32, 0x32, 0x05, 0x14, 0x32, 0xA4, 0x9E,
	0x66, 0x04, 0xF6, 0x33, 0xF2, 0x65, 0xA4, 0xA1, 0x30, 0x00, 0x14, 0x32,
	0x31, 0x00, 0x14, 0x32, 0x32, 0x04, 0x14, 0x32, 0xA4, 0xA5, 0xDA, 0xB4,
	0x7B, 0x05, 0xA4, 0xE5, 0xD8, 0xB4, 0xA4, 0xE1, 0xD9, 0xB4, 0xA4, 0xA1,
	0x66, 0x04, 0xF6, 0x1E, 0xDA, 0xB4, 0x7B, 0x05, 0xA4, 0xE9, 0xD8, 0xB4,
	0xA4, 0xED, 0xD9, 0xB4, 0xA4, 0xA5, 0x66, 0xFF, 0x76, 0x0A, 0x36, 0x09,
	0xA4, 0xA1, 0x86, 0x66, 0x36, 0x04, 0xA4, 0xA1, 0x66, 0xFF, 0x60, 0x0A,
	0x86, 0x04, 0x36, 0x09, 0xA4, 0xA1, 0x86, 0x66, 0x36, 0x04, 0xA4, 0xA1,
	0x66, 0xFF, 0x86, 0x6E, 0x86, 0x66, 0x36, 0x7F, 0xA4, 0xA1, 0x86, 0x66,
	0x86, 0x6E, 0x36, 0x7E, 0xA4, 0xA1, 0x66, 0x05, 0x76, 0xF6, 0x36, 0xFB,
	0xA4, 0xA1, 0x66, 0x05, 0x86, 0x05, 0x36, 0xFB, 0xA4, 0xA1, 0x66, 0x05,
	0x80, 0x67, 0x30, 0xFB, 0xA4, 0xA1, 0xDA, 0xB4, 0x14, 0x9C, 0xAA, 0x55,
	0x00, 0x00, 0xA0, 0x40, 0xA0, 0x00, 0xA0, 0xC0, 0x80, 0xE0, 0xA0, 0xA0,
	0xE0, 0xC0, 0x40, 0x40, 0xE0, 0xE0, 0x20, 0xC0, 0xE0, 0xE0, 0x60, 0x20,
	0xE0, 0xA0, 0xE0, 0x20, 0x20, 0xE0, 0xC0, 0x20, 0xC0, 0x60, 0x80, 0xE0,
	0xE0, 0xE0, 0x20, 0x40, 0x40, 0xE0, 0xE0, 0xA0, 0xE0, 0xE0, 0xE0, 0x20,
	0xC0, 0x40, 0xA0, 0xE0, 0xA0, 0xC0, 0xE0, 0xA0, 0xE0, 0xE0, 0x80, 0x80,
	0xE0, 0xC0, 0xA0, 0xA0, 0xC0, 0xE0, 0xC0, 0x80, 0xE0, 0xE0, 0x80, 0xC0,
	0x80, 0x00, 0xA0, 0xA0, 0x40, 0xA0, 0x40, 0xA0, 0xA0, 0x0A, 0xAE, 0xA2,
	0x42, 0x38, 0x08, 0x30, 0xB8
];


state = "OFF"
function setMem(){
    ram = []
    for(let i = 0; i < 4096; i++){
        ram.push(0)
    }

    regs = []
    for(let i = 0; i < 16; i++){
        regs.push(0)
    }

    PC = 0x200
    DT = 0
    ST = 0
    I = 0
	stack = []
}

function insertRom(){
    for(let i = 0; i < rom.length; i++){
        ram[i + 0x200] = rom[i]
    }
}

function resetDisplay(){
    OFF = "Yellow Concrete"
    ON = "Orange Concrete"
    
    dis = []
    for(let i = 0; i < 32; i++){
        dis.push([])
        for(let x = 0; x < 64; x++){
            dis[i].push(0)
        }
    }
    
    for(let i = 0; i < 8; i++){
        api.setBlockRect([i*8, 0, 0], [i*8 + 8, 32, 0], OFF)
    }
    
}

function DXYN(x,y,n){
    x = regs[x] & 63
    y = regs[y] & 31
    console.log(`${x} and ${y}`)
    regs[0xF] = 0
    for(let h = 0; h < n; h++){
        let data = ram[I + h].toString(2)
        while(data.length < 8){data = "0" + data}
        console.log(data)
        for(let m = 0; m < 8; m++){
            if(dis[y][x + m] == 1){
                regs[0xF] = 1
            }
            dis[y][x+m] ^= +data[m]
			if(x+m < 64 && x > 0 && y < 32){
            	if(dis[y][x+m] == 1){
					api.setBlock(x+m,32-y,0,ON)
				} else {
					api.setBlock(x+m,32-y,0,OFF)
				}
			}
        }
        y++
    }
}
function swc8(X,Y,N,NN,NNN){
	switch(N){
		case 0:
			regs[X] = regs[Y]
			break
		case 1:
			regs[X] |= regs[Y]
			break
		case 2:
			regs[X] &= regs[Y]
			break
		case 3:
			regs[X] ^= regs[Y]
			break
		case 4:
			regs[X] = regs[X] + regs[Y]
			if(regs[X] > 255){
				regs[X] &= 255
				regs[15] = 1
			} else {
				regs[15] = 0
			}
			break
		case 5:
			let tmp = regs[X] - regs[Y]
			if(tmp < 0){
				tmp += 256
				regs[15] = 0
			} else {
				regs[15] = 1
			}
			regs[X] = tmp
			break
		case 7:
			let tmp = regs[Y] - regs[X]
			if(tmp < 0){
				tmp += 256
				regs[15] = 0
			} else {
				regs[15] = 1
			}
			regs[X] = tmp
			break
	}
}

function interpret(n){
    console.log(n.toString(16))
    let opCode = n
    let prefix = (opCode & 0xF000) >> 12
    let X = (opCode & 0x0F00) >> 8
    let Y = (opCode & 0x00F0) >> 4
    let N = (opCode & 0x000F)
    let NN = (opCode & 0x00FF)
    let NNN = (opCode & 0x0FFF)
    console.log(`${PC}, ${prefix}, ${X}, ${Y}, ${N}, ${NN}, ${NNN}`)

    switch( prefix ){
        case 0:
			switch(N){
				case 0:
            		for(let i = 0; i < 32; i++){
                		for(let j = 0; j < 64; j++){
                    		dis[i][j] = 0
                		}
            		}
					break
				case 14:
					PC = stack.shift()
					break
			}
            break
        case 1:
			if(NNN == PC){
				state = "HALT"
			}
            PC = NNN
            break
		case 2:
			stack.push(PC)
			PC = NNN
		case 3:
			if(regs[X] == NN){
				PC += 2
			}
			break
		case 4:
			if(regs[X] != NN){
				PC += 2
			}
			break
		case 5:
			if(regs[X] == regs[Y]){
				PC += 2
			}
			break
        case 6:
            regs[X] = NN
            break
        case 7:
            regs[X] = (regs[X] + NN) & 255
            break
		case 8:
			swc8(X,Y,N,NN,NNN)
			break
		case 9:
			if(regs[X] != regs[Y]){
				PC += 2
			}
        case 10:
            I = NNN
            break
        case 13:
            DXYN(X,Y,N)
            break
            
    }
    
}


function tick(){
    switch (state){
        case "OFF":
            setMem()
            state = "ON"
            break
        case "ON":
            insertRom()
            state = "DRAWING"
            break
        case "DRAWING":
            resetDisplay()
            state = "RUNNING"
            break
        case "RUNNING":
            if(DT > 0){
                DT--
            }
            if(ST > 0){
                ST--
            }
            let j = 256 * ram[PC] + ram[PC + 1]
            PC += 2
            interpret(j)
            break
    }
}


